// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Domain: IAM - User
// See `docs/domain/1.iam.md` for the canonical shape.
model User {
  userId        String   @id @default(uuid())
  externalAuthId String  @unique
  email         String   @unique
  firstName     String?
  lastName      String?
  isActive      Boolean  @default(true)
  userMetadata  Json?
  createdAt     DateTime @default(now())
  lastSyncedAt  DateTime?
  userRoles     UserRole[]
  passwordResetTokens PasswordResetToken[]
}

// Enums for role scope and user role scope
enum ScopeType {
  None
  Forum
  Area
  Unit
  Agent
}

model Role {
  roleId       String   @id @default(uuid())
  roleCode     String   @unique
  roleName     String
  description  String?
  scopeType    ScopeType
  isActive     Boolean  @default(true)
  isSystemRole Boolean  @default(false)
  createdAt    DateTime @default(now())
  createdBy    String?
  updatedAt    DateTime?

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  permissionId   String   @id @default(uuid())
  permissionCode String   @unique
  permissionName String
  description    String?
  module         String?
  action         String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  createdBy      String?

  rolePermissions RolePermission[]
}

model RolePermission {
  rolePermissionId String   @id @default(uuid())
  role             Role     @relation(fields: [roleId], references: [roleId])
  roleId           String
  permission       Permission @relation(fields: [permissionId], references: [permissionId])
  permissionId     String
  conditions       Json?
  assignedAt       DateTime @default(now())
  assignedBy       String?
}

model UserRole {
  userRoleId     String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [userId])
  userId         String
  role           Role     @relation(fields: [roleId], references: [roleId])
  roleId         String
  scopeEntityType ScopeType?
  scopeEntityId  String?
  isActive       Boolean  @default(true)
  assignedAt     DateTime @default(now())
  assignedBy     String?
  revokedAt      DateTime?
  revokedBy      String?
}

// Domain: Event Bus - Event Store for Audit Trail
model Event {
  eventId       String   @id @default(uuid())
  eventType     String
  aggregateId   String?
  eventData     Json
  userId        String?
  ipAddress     String?
  timestamp     DateTime @default(now())

  @@index([eventType])
  @@index([aggregateId])
  @@index([timestamp])
}

// Password reset tokens for backend-controlled reset flow
model PasswordResetToken {
  tokenId    String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [userId])
  userId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([tokenHash])
  @@index([userId, expiresAt])
}

