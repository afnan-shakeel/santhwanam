// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===== SYSTEM CONFIGURATION =====
// Key-value store for application settings
// See docs/implementations/update-99-remove-wallet-debit-request.md

model SystemConfiguration {
  configId    String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  dataType    String   @default("string") // string, boolean, number, json
  updatedBy   String?
  updatedAt   DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([key])
}

// Domain: IAM - User
// See `docs/domain/1.iam.md` for the canonical shape.
model User {
  userId                  String                   @id @default(uuid())
  externalAuthId          String                   @unique
  email                   String                   @unique
  firstName               String?
  lastName                String?
  isActive                Boolean                  @default(true)
  userMetadata            Json?
  createdAt               DateTime                 @default(now())
  lastSyncedAt            DateTime?
  userRoles               UserRole[]
  passwordResetTokens     PasswordResetToken[]
  agents                  Agent[]
  members                 Member[]
  approvalRequests        ApprovalRequest[]
  approvalStageExecutions ApprovalStageExecution[]

  // Cash Management relations
  cashCustodies              CashCustody[]
  cashCustodiesDeactivatedBy CashCustody[]    @relation("CashCustodyDeactivatedBy")
  handoversFrom              CashHandover[]   @relation("HandoverFromUser")
  handoversTo                CashHandover[]   @relation("HandoverToUser")
  handoversCreated           CashHandover[]   @relation("HandoverCreatedBy")
}

// Enums for role scope and user role scope
enum ScopeType {
  None
  Forum
  Area
  Unit
  Agent
  Member
}

model Role {
  roleId       String    @id @default(uuid())
  roleCode     String    @unique
  roleName     String
  description  String?
  scopeType    ScopeType
  isActive     Boolean   @default(true)
  isSystemRole Boolean   @default(false)
  createdAt    DateTime  @default(now())
  createdBy    String?
  updatedAt    DateTime?

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  permissionId   String   @id @default(uuid())
  permissionCode String   @unique
  permissionName String
  description    String?
  module         String?
  action         String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  createdBy      String?

  rolePermissions RolePermission[]
}

model RolePermission {
  rolePermissionId String     @id @default(uuid())
  role             Role       @relation(fields: [roleId], references: [roleId])
  roleId           String
  permission       Permission @relation(fields: [permissionId], references: [permissionId])
  permissionId     String
  conditions       Json?
  assignedAt       DateTime   @default(now())
  assignedBy       String?
}

model UserRole {
  userRoleId      String     @id @default(uuid())
  user            User       @relation(fields: [userId], references: [userId])
  userId          String
  role            Role       @relation(fields: [roleId], references: [roleId])
  roleId          String
  scopeEntityType ScopeType?
  scopeEntityId   String?
  isActive        Boolean    @default(true)
  assignedAt      DateTime   @default(now())
  assignedBy      String?
  revokedAt       DateTime?
  revokedBy       String?
}

// Domain: Event Bus - Event Store for Audit Trail
model Event {
  eventId     String   @id @default(uuid())
  eventType   String
  aggregateId String?
  eventData   Json
  userId      String?
  ipAddress   String?
  timestamp   DateTime @default(now())

  @@index([eventType])
  @@index([aggregateId])
  @@index([timestamp])
}

// Password reset tokens for backend-controlled reset flow
model PasswordResetToken {
  tokenId   String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [userId])
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tokenHash])
  @@index([userId, expiresAt])
}

// Domain: Approval Workflow
// See `docs/domain/2.approval_workflow.md` for details

enum WorkflowModule {
  Agents
  Membership
  Wallet
  Claims
  Contributions
  Organization
  CashManagement
}

enum ApproverType {
  Role
  SpecificUser
  Hierarchy
  OrganizationAdmin
}

enum OrganizationBody {
  Unit
  Area
  Forum
}

enum ApprovalRequestStatus {
  Pending
  Approved
  Rejected
  Cancelled
}

enum ApprovalStageStatus {
  Pending
  Approved
  Rejected
  Skipped
}

enum ApprovalDecision {
  Approve
  Reject
}

model ApprovalWorkflow {
  workflowId        String         @id @default(uuid())
  workflowCode      String         @unique
  workflowName      String
  description       String?
  module            WorkflowModule
  entityType        String
  isActive          Boolean        @default(true)
  requiresAllStages Boolean        @default(true)
  createdAt         DateTime       @default(now())
  createdBy         String?
  updatedAt         DateTime?
  updatedBy         String?

  stages   ApprovalStage[]
  requests ApprovalRequest[]

  @@index([workflowCode])
}

model ApprovalStage {
  stageId          String            @id @default(uuid())
  workflow         ApprovalWorkflow  @relation(fields: [workflowId], references: [workflowId])
  workflowId       String
  stageName        String
  stageOrder       Int
  approverType     ApproverType
  roleId           String?
  userId           String?
  organizationBody OrganizationBody?
  isOptional       Boolean           @default(false)
  autoApprove      Boolean           @default(false)
  createdBy        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime?
  updatedBy        String?

  executions ApprovalStageExecution[]

  @@unique([workflowId, stageOrder])
  @@index([workflowId, stageOrder])
}

model ApprovalRequest {
  requestId         String                @id @default(uuid())
  workflow          ApprovalWorkflow      @relation(fields: [workflowId], references: [workflowId])
  workflowId        String
  entityType        String
  entityId          String
  forumId           String?
  areaId            String?
  unitId            String?
  requestedBy       String
  requestedByUser   User                  @relation(fields: [requestedBy], references: [userId])
  requestedAt       DateTime
  status            ApprovalRequestStatus @default(Pending)
  currentStageOrder Int?
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime?

  stageExecutions       ApprovalStageExecution[]
  agents                Agent[]
  walletDepositRequests WalletDepositRequest[]
  deathClaims           DeathClaim[]
  cashHandovers         CashHandover[]

  @@index([entityType, entityId])
  @@index([status])
  @@index([requestedBy])
}

model ApprovalStageExecution {
  executionId        String              @id @default(uuid())
  request            ApprovalRequest     @relation(fields: [requestId], references: [requestId])
  requestId          String
  stage              ApprovalStage       @relation(fields: [stageId], references: [stageId])
  stageId            String
  stageOrder         Int
  status             ApprovalStageStatus @default(Pending)
  assignedApproverId String?
  reviewedBy         String?
  reviewedByUser     User?               @relation(fields: [reviewedBy], references: [userId])
  reviewedAt         DateTime?
  decision           ApprovalDecision?
  comments           String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime?

  @@index([requestId])
  @@index([assignedApproverId, status])
}

// Domain: Organization Bodies
// See `docs/domain/3.organization_bodies.md` for details

model Forum {
  forumId         String    @id @default(uuid())
  forumCode       String    @unique
  forumName       String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime  @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  areas              Area[]
  contributionCycles ContributionCycle[]

  // Cash Management relations
  cashCustodies CashCustody[]
  cashHandovers CashHandover[]

  @@index([forumCode])
  @@index([adminUserId])
}

model Area {
  areaId          String    @id @default(uuid())
  forum           Forum     @relation(fields: [forumId], references: [forumId])
  forumId         String
  areaCode        String
  areaName        String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime  @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  units Unit[]

  // Cash Management relations
  cashCustodies CashCustody[]

  @@unique([forumId, areaCode])
  @@index([forumId])
  @@index([adminUserId])
}

model Unit {
  unitId          String    @id @default(uuid())
  area            Area      @relation(fields: [areaId], references: [areaId])
  areaId          String
  forumId         String
  unitCode        String
  unitName        String
  adminUserId     String
  establishedDate DateTime
  createdAt       DateTime  @default(now())
  createdBy       String
  updatedAt       DateTime?
  updatedBy       String?

  agents      Agent[]
  members     Member[]
  deathClaims DeathClaim[]

  // Cash Management relations
  cashCustodies CashCustody[]

  @@unique([areaId, unitCode])
  @@index([areaId])
  @@index([forumId])
  @@index([adminUserId])
}

// Domain: Agents
// See `docs/domain/4.agents.md` for details

enum RegistrationStatus {
  Draft
  PendingApproval
  Approved
  Rejected
}

enum AgentStatus {
  Active
  Inactive
  Suspended
  Terminated
}

enum Gender {
  Male
  Female
  Other
}

model Agent {
  agentId            String             @id @default(uuid())
  agentCode          String
  registrationStatus RegistrationStatus @default(Draft)
  approvalRequest    ApprovalRequest?   @relation(fields: [approvalRequestId], references: [requestId])
  approvalRequestId  String?

  // Hierarchy (denormalized for query efficiency)
  unit    Unit   @relation(fields: [unitId], references: [unitId])
  unitId  String
  areaId  String
  forumId String

  // User reference (set after approval)
  user   User?   @relation(fields: [userId], references: [userId])
  userId String?

  // Personal Details
  firstName   String
  middleName  String?
  lastName    String
  dateOfBirth DateTime
  gender      Gender

  // Contact Information
  contactNumber          String
  alternateContactNumber String?
  email                  String  @unique

  // Address (optional)
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Agent Status
  agentStatus AgentStatus @default(Active)

  // Statistics
  totalActiveMembers Int @default(0)
  totalRegistrations Int @default(0)

  // Metadata
  joinedDate        DateTime?
  terminatedDate    DateTime?
  terminationReason String?

  // Audit fields
  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime?
  updatedBy String?

  // Relations
  members       Member[]
  deathClaims   DeathClaim[]
  contributions MemberContribution[]

  @@unique([unitId, agentCode])
  @@index([unitId])
  @@index([areaId])
  @@index([forumId])
  @@index([userId])
  @@index([email])
  @@index([approvalRequestId])
  @@index([registrationStatus])
  @@index([agentStatus])
}

// Domain: Members
// See `docs/domain/5.membership.md` for details

enum MemberRegistrationStatus {
  Draft
  PendingApproval
  Approved
  Rejected
}

enum MemberRegistrationStep {
  PersonalDetails
  Nominees
  DocumentsPayment
  Completed
}

enum MemberStatus {
  Active
  Frozen
  Suspended
  Closed
  Deceased
}

enum RelationType {
  Father
  Mother
  Spouse
  Son
  Daughter
  Brother
  Sister
  Other
}

enum IdProofType {
  NationalID
  Passport
  DrivingLicense
  VoterID
  Other
}

enum DocumentType {
  NationalID
  Passport
  DrivingLicense
  BirthCertificate
  ResidenceCard
  AddressProof_UtilityBill
  AddressProof_BankStatement
  AddressProof_RentalAgreement
  MemberPhoto
  NomineeIDProof
  Other
}

enum DocumentCategory {
  MemberIdentity
  MemberAddress
  MemberPhoto
  NomineeProof
  Other
}

enum DocumentVerificationStatus {
  Pending
  Verified
  Rejected
}

enum CollectionMode {
  Cash
  BankTransfer
  Cheque
  Online
}

enum PaymentApprovalStatus {
  PendingApproval
  Approved
  Rejected
}

model Member {
  memberId   String @id @default(uuid())
  memberCode String @unique

  // Registration tracking
  registrationStatus MemberRegistrationStatus @default(Draft)
  registrationStep   MemberRegistrationStep   @default(PersonalDetails)
  approvalRequestId  String?

  // Personal Details
  firstName              String
  middleName             String?
  lastName               String
  dateOfBirth            DateTime
  gender                 Gender
  contactNumber          String
  alternateContactNumber String?
  email                  String?

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String

  // Membership details
  tier   MembershipTier @relation(fields: [tierId], references: [tierId])
  tierId String

  // Hierarchy
  agent   Agent  @relation(fields: [agentId], references: [agentId])
  agentId String
  unit    Unit   @relation(fields: [unitId], references: [unitId])
  unitId  String
  areaId  String
  forumId String

  // Member Status (after approval)
  memberStatus MemberStatus?

  // Suspension tracking
  suspensionCounter Int       @default(0)
  suspensionReason  String?
  suspendedAt       DateTime?

  // User reference (set after approval)
  user   User?   @relation(fields: [userId], references: [userId])
  userId String?

  // Timestamps
  createdAt    DateTime  @default(now())
  registeredAt DateTime?
  updatedAt    DateTime?

  // Audit
  createdBy  String
  approvedBy String?

  // Relations
  nominees              Nominee[]
  documents             MemberDocument[]
  payment               RegistrationPayment?
  wallet                Wallet?
  walletDepositRequests WalletDepositRequest[]
  walletDebitRequests   WalletDebitRequest[]
  deathClaims           DeathClaim[]
  contributions         MemberContribution[]

  @@index([memberCode])
  @@index([registrationStatus])
  @@index([memberStatus])
  @@index([agentId])
  @@index([unitId])
  @@index([tierId])
  @@index([approvalRequestId])
}

model Nominee {
  nomineeId String @id @default(uuid())
  member    Member @relation(fields: [memberId], references: [memberId])
  memberId  String

  // Nominee details
  name                   String
  relationType           RelationType
  dateOfBirth            DateTime
  contactNumber          String
  alternateContactNumber String?

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String

  // ID Proof
  idProofType       IdProofType
  idProofNumber     String
  idProofDocumentId String?

  // Priority (Phase 2 - default to 1)
  priority Int @default(1)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  // Relations
  documents MemberDocument[]

  @@index([memberId])
  @@index([memberId, isActive])
}

model MemberDocument {
  documentId String   @id @default(uuid())
  member     Member   @relation(fields: [memberId], references: [memberId])
  memberId   String
  nominee    Nominee? @relation(fields: [nomineeId], references: [nomineeId])
  nomineeId  String?

  // Document details
  documentType     DocumentType
  documentCategory DocumentCategory
  documentName     String

  // File storage
  fileUrl  String
  fileSize Int
  mimeType String

  // Metadata
  uploadedBy String
  uploadedAt DateTime @default(now())

  // Verification
  verificationStatus DocumentVerificationStatus @default(Pending)
  verifiedBy         String?
  verifiedAt         DateTime?
  rejectionReason    String?

  // Optional
  expiryDate DateTime?

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  @@index([memberId])
  @@index([nomineeId])
  @@index([memberId, documentCategory, isActive])
}

model RegistrationPayment {
  paymentId String @id @default(uuid())
  member    Member @relation(fields: [memberId], references: [memberId])
  memberId  String @unique

  // Payment details
  registrationFee Decimal @db.Decimal(15, 2)
  advanceDeposit  Decimal @db.Decimal(15, 2)
  totalAmount     Decimal @db.Decimal(15, 2)

  // Collection details
  collectedBy     String // AgentId
  collectionDate  DateTime
  collectionMode  CollectionMode
  referenceNumber String?

  // Approval status
  approvalStatus  PaymentApprovalStatus @default(PendingApproval)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  @@index([memberId])
}

model MembershipTier {
  tierId      String  @id @default(uuid())
  tierCode    String  @unique
  tierName    String
  description String?

  // Financial amounts
  registrationFee      Decimal @db.Decimal(15, 2)
  advanceDepositAmount Decimal @db.Decimal(15, 2)
  contributionAmount   Decimal @db.Decimal(15, 2)
  deathBenefitAmount   Decimal @db.Decimal(15, 2)

  // Status
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime?

  // Relations
  members       Member[]
  deathClaims   DeathClaim[]
  contributions MemberContribution[]

  @@index([tierCode])
  @@index([isActive])
  @@index([isDefault])
}

// ===================================
// Domain: General Ledger (GL)
// See `docs/domain/6.gl.md`
// ===================================

enum AccountType {
  Asset
  Liability
  Revenue
  Expense
  Equity
}

enum NormalBalance {
  Debit
  Credit
}

enum EntryStatus {
  Draft
  Posted
  Reversed
}

enum PeriodStatus {
  Open
  Closed
}

// Chart of Accounts
model ChartOfAccount {
  accountId       String      @id @default(uuid())
  accountCode     String      @unique
  accountName     String
  accountType     AccountType
  accountCategory String?

  // Hierarchy
  parentAccount   ChartOfAccount?  @relation("AccountHierarchy", fields: [parentAccountId], references: [accountId])
  parentAccountId String?
  childAccounts   ChartOfAccount[] @relation("AccountHierarchy")
  accountLevel    Int              @default(1)

  // Balance tracking
  normalBalance  NormalBalance
  currentBalance Decimal       @default(0) @db.Decimal(15, 2)

  // Status
  isActive        Boolean @default(true)
  isSystemAccount Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime?
  updatedBy String?

  // Relations
  journalEntryLines JournalEntryLine[]

  @@index([accountCode])
  @@index([accountType])
  @@index([isActive])
  @@index([parentAccountId])
  @@index([isSystemAccount])
}

// Journal Entry
model JournalEntry {
  entryId     String @id @default(uuid())
  entryNumber String @unique

  // Entry details
  entryDate   DateTime
  postingDate DateTime?
  description String
  reference   String?

  // Source tracking
  sourceModule          String
  sourceEntityId        String?
  sourceTransactionType String

  // Status
  entryStatus EntryStatus @default(Draft)

  // Reversal tracking
  reversedEntry   JournalEntry?  @relation("EntryReversal", fields: [reversedEntryId], references: [entryId])
  reversedEntryId String?
  reversedByEntry JournalEntry[] @relation("EntryReversal")
  reversalReason  String?
  reversedAt      DateTime?
  reversedBy      String?

  // Validation
  totalDebit  Decimal @default(0) @db.Decimal(15, 2)
  totalCredit Decimal @default(0) @db.Decimal(15, 2)
  isBalanced  Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  createdBy String
  postedAt  DateTime?
  postedBy  String?
  updatedAt DateTime?

  // Relations
  lines                 JournalEntryLine[]
  walletTransactions    WalletTransaction[]
  walletDepositRequests WalletDepositRequest[]
  deathClaims           DeathClaim[]
  contributions         MemberContribution[]
  cashHandovers         CashHandover[]

  @@index([entryNumber])
  @@index([entryDate])
  @@index([entryStatus])
  @@index([sourceModule, sourceEntityId])
  @@index([reversedEntryId])
  @@index([isBalanced])
}

// Journal Entry Line
model JournalEntryLine {
  lineId  String       @id @default(uuid())
  entry   JournalEntry @relation(fields: [entryId], references: [entryId], onDelete: Cascade)
  entryId String

  lineNumber Int

  // Account reference
  account     ChartOfAccount @relation(fields: [accountId], references: [accountId])
  accountId   String
  accountCode String
  accountName String

  // Amounts
  debitAmount  Decimal @default(0) @db.Decimal(15, 2)
  creditAmount Decimal @default(0) @db.Decimal(15, 2)

  description String

  // Timestamps
  createdAt DateTime @default(now())

  @@index([entryId])
  @@index([accountId])
  @@index([entryId, lineNumber])
}

// Fiscal Period
model FiscalPeriod {
  periodId     String @id @default(uuid())
  fiscalYear   Int
  periodNumber Int
  periodName   String

  startDate DateTime
  endDate   DateTime

  status PeriodStatus @default(Open)

  closedAt DateTime?
  closedBy String?

  createdAt DateTime @default(now())

  @@unique([fiscalYear, periodNumber])
  @@index([fiscalYear])
  @@index([status])
  @@index([startDate, endDate])
}

// ===================================
// Domain: Membership Wallet
// See `docs/domain/7.membership_wallet.md`
// ===================================

enum WalletTransactionType {
  Deposit
  Debit
  Refund
  Adjustment
}

enum WalletTransactionStatus {
  Pending
  Completed
  Failed
  Reversed
}

enum WalletDepositRequestStatus {
  Draft
  PendingApproval
  Approved
  Rejected
}

// Wallet Debit Request Status
// NOTE: With auto-debit enabled, requests are created directly with Completed status.
// DEPRECATED statuses (kept for backward compatibility):
// - PendingAcknowledgment: No longer used when auto-debit is enabled
// - Acknowledged: No longer used when auto-debit is enabled
// Active statuses: Completed, Failed, Invalidated
// See docs/implementations/update-99-remove-wallet-debit-request.md
enum WalletDebitRequestStatus {
  PendingAcknowledgment // DEPRECATED: Use only when autoDebit is disabled
  Acknowledged // DEPRECATED: Use only when autoDebit is disabled
  Completed
  Invalidated
  Failed
}

// Member Wallet
model Wallet {
  walletId String @id @default(uuid())
  member   Member @relation(fields: [memberId], references: [memberId])
  memberId String @unique

  currentBalance Decimal @default(0) @db.Decimal(15, 2)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  // Relations
  transactions    WalletTransaction[]
  depositRequests WalletDepositRequest[]
  debitRequests   WalletDebitRequest[]

  @@index([memberId])
}

// Wallet Transaction
model WalletTransaction {
  transactionId String @id @default(uuid())
  wallet        Wallet @relation(fields: [walletId], references: [walletId])
  walletId      String

  transactionType WalletTransactionType
  amount          Decimal               @db.Decimal(15, 2)
  balanceAfter    Decimal               @db.Decimal(15, 2)

  // Reference
  sourceModule   String
  sourceEntityId String?

  // Description
  description String

  // Financial - GL reference
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [entryId])
  journalEntryId String?

  // Status
  status WalletTransactionStatus @default(Completed)

  // Audit
  createdBy String
  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([transactionType])
  @@index([sourceModule, sourceEntityId])
  @@index([createdAt])
}

// Wallet Deposit Request
model WalletDepositRequest {
  depositRequestId String @id @default(uuid())
  member           Member @relation(fields: [memberId], references: [memberId])
  memberId         String
  wallet           Wallet @relation(fields: [walletId], references: [walletId])
  walletId         String

  amount         Decimal  @db.Decimal(15, 2)
  collectionDate DateTime
  collectedBy    String // AgentId
  notes          String?

  // Status
  requestStatus WalletDepositRequestStatus @default(Draft)

  // Approval
  approvalRequest   ApprovalRequest? @relation(fields: [approvalRequestId], references: [requestId])
  approvalRequestId String?

  // Financial - GL reference
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [entryId])
  journalEntryId String?

  // Timestamps
  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  rejectedAt DateTime?

  @@index([memberId])
  @@index([walletId])
  @@index([requestStatus])
  @@index([collectedBy])
}

// Wallet Debit Request
// NOTE: With auto-debit enabled (wallet.autoDebitEnabled=true), debit requests are created
// with status=Completed and isAutoDebit=true immediately when contribution cycle starts.
// The manual acknowledgment flow (PendingAcknowledgment → Acknowledged) is DEPRECATED.
// See docs/implementations/update-99-remove-wallet-debit-request.md
model WalletDebitRequest {
  debitRequestId String @id @default(uuid())
  member         Member @relation(fields: [memberId], references: [memberId])
  memberId       String
  wallet         Wallet @relation(fields: [walletId], references: [walletId])
  walletId       String

  amount  Decimal @db.Decimal(15, 2)
  purpose String

  // References
  contributionCycleId String?
  contributionId      String?

  // Status
  // DEPRECATED statuses (kept for backward compatibility):
  // - PendingAcknowledgment: No longer used when auto-debit is enabled
  // - Acknowledged: No longer used when auto-debit is enabled
  // Active statuses: Completed, Failed, Invalidated
  status WalletDebitRequestStatus @default(PendingAcknowledgment)

  // Auto-debit flag: true when processed automatically without agent acknowledgment
  isAutoDebit Boolean @default(false)

  // Failure tracking (for Failed status)
  failureReason String?

  // Timestamps
  createdAt      DateTime  @default(now())
  acknowledgedAt DateTime? // DEPRECATED: Not set when isAutoDebit=true
  completedAt    DateTime?
  processedAt    DateTime? // Set when auto-debit processes the request

  // Relations
  contributions MemberContribution[]

  @@index([memberId])
  @@index([walletId])
  @@index([status])
  @@index([contributionId])
  @@index([isAutoDebit])
}

// ===== DEATH CLAIMS CONTEXT =====
// See docs/domain/8.death_claims_and_contribution.md

enum DeathClaimStatus {
  Reported
  UnderVerification
  Verified
  PendingApproval
  Approved
  Settled
  Rejected
}

enum DeathClaimVerificationStatus {
  Pending
  InProgress
  Completed
  Rejected
}

enum DeathClaimSettlementStatus {
  Pending
  Completed
}

enum PaymentMethod {
  Cash
  BankTransfer
  Cheque
}

enum ClaimDocumentType {
  DeathCertificate
  NewspaperClipping
  PoliceReport
  MedicalReport
  PostMortemReport
  Other
}

enum ClaimDocumentVerificationStatus {
  Pending
  Verified
  Rejected
}

model DeathClaim {
  claimId     String @id @default(uuid())
  claimNumber String @unique

  // Registration tracking
  claimStatus DeathClaimStatus @default(Reported)

  // Approval tracking
  approvalRequest   ApprovalRequest? @relation(fields: [approvalRequestId], references: [requestId])
  approvalRequestId String?

  // Member info
  member     Member         @relation(fields: [memberId], references: [memberId])
  memberId   String
  memberCode String
  memberName String
  tier       MembershipTier @relation(fields: [tierId], references: [tierId])
  tierId     String

  // Hierarchy
  agent   Agent  @relation(fields: [agentId], references: [agentId])
  agentId String
  unit    Unit   @relation(fields: [unitId], references: [unitId])
  unitId  String
  areaId  String
  forumId String

  // Death details
  deathDate    DateTime
  deathPlace   String?
  causeOfDeath String?

  // Reporting
  reportedBy     String
  reportedByRole String
  reportedDate   DateTime @default(now())
  initialNotes   String?

  // Nominee info (snapshot at time of death)
  nomineeId            String
  nomineeName          String
  nomineeRelation      String
  nomineeContactNumber String
  nomineeAddress       Json

  // Benefit
  benefitAmount Decimal? @db.Decimal(15, 2)

  // Verification
  verificationStatus DeathClaimVerificationStatus @default(Pending)
  verifiedBy         String?
  verifiedDate       DateTime?
  verificationNotes  String?

  // Settlement
  settlementStatus      DeathClaimSettlementStatus @default(Pending)
  paymentMethod         PaymentMethod?
  paymentReference      String?
  paymentDate           DateTime?
  paidBy                String?
  nomineeAcknowledgment String? // File URL

  // Financial
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [entryId])
  journalEntryId String?

  // Timestamps
  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  settledAt  DateTime?
  updatedAt  DateTime?

  // Audit
  approvedBy      String?
  rejectedBy      String?
  rejectionReason String?

  // Relations
  documents          DeathClaimDocument[]
  contributionCycles ContributionCycle[]

  @@index([claimNumber])
  @@index([memberId])
  @@index([claimStatus])
  @@index([approvalRequestId])
  @@index([agentId])
  @@index([unitId])
  @@index([forumId])
}

model DeathClaimDocument {
  documentId String     @id @default(uuid())
  claim      DeathClaim @relation(fields: [claimId], references: [claimId])
  claimId    String

  documentType ClaimDocumentType
  documentName String
  fileUrl      String
  fileSize     Int
  mimeType     String

  uploadedBy String
  uploadedAt DateTime @default(now())

  verificationStatus ClaimDocumentVerificationStatus @default(Pending)
  verifiedBy         String?
  verifiedAt         DateTime?
  rejectionReason    String?

  @@index([claimId])
  @@index([documentType])
}

// ===== CONTRIBUTION COLLECTION CONTEXT =====
// See docs/domain/8.death_claims_and_contribution.md (Part 2)

enum ContributionCycleStatus {
  Active
  Closed
}

// Member Contribution Status
// NOTE: With auto-debit enabled, contributions go directly from Pending → Collected
// DEPRECATED statuses (kept for backward compatibility):
// - WalletDebitRequested: No longer used when auto-debit is enabled
// - Acknowledged: No longer used when auto-debit is enabled
// See docs/implementations/update-99-remove-wallet-debit-request.md
enum MemberContributionStatus {
  Pending
  WalletDebitRequested // DEPRECATED: Use only when autoDebit is disabled
  Acknowledged // DEPRECATED: Use only when autoDebit is disabled
  Collected
  Missed
  Exempted
}

enum ContributionPaymentMethod {
  Wallet
  DirectCash
}

model ContributionCycle {
  cycleId     String @id @default(uuid())
  cycleNumber String @unique

  // Linked to death claim
  deathClaim         DeathClaim @relation(fields: [deathClaimId], references: [claimId])
  deathClaimId       String
  claimNumber        String
  deceasedMemberId   String
  deceasedMemberName String
  benefitAmount      Decimal    @db.Decimal(15, 2)

  // Hierarchy
  forum   Forum  @relation(fields: [forumId], references: [forumId])
  forumId String

  // Cycle details
  startDate          DateTime
  collectionDeadline DateTime

  // Status
  cycleStatus ContributionCycleStatus @default(Active)

  // Statistics
  totalMembers         Int
  totalExpectedAmount  Decimal @db.Decimal(15, 2)
  totalCollectedAmount Decimal @default(0) @db.Decimal(15, 2)
  totalPendingAmount   Decimal @db.Decimal(15, 2)
  membersCollected     Int     @default(0)
  membersPending       Int
  membersMissed        Int     @default(0)

  // Closure
  closedDate DateTime?
  closedBy   String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  // Relations
  contributions MemberContribution[]

  @@index([cycleNumber])
  @@index([deathClaimId])
  @@index([cycleStatus])
  @@index([forumId])
}

model MemberContribution {
  contributionId String @id @default(uuid())

  cycle   ContributionCycle @relation(fields: [cycleId], references: [cycleId])
  cycleId String

  // Member info
  member     Member         @relation(fields: [memberId], references: [memberId])
  memberId   String
  memberCode String
  memberName String
  tier       MembershipTier @relation(fields: [tierId], references: [tierId])
  tierId     String
  agent      Agent          @relation(fields: [agentId], references: [agentId])
  agentId    String

  // Amount
  expectedAmount Decimal @db.Decimal(15, 2)

  // Status
  contributionStatus MemberContributionStatus @default(Pending)

  // Payment details
  paymentMethod  ContributionPaymentMethod?
  collectionDate DateTime?
  collectedBy    String?

  // Wallet tracking
  walletDebitRequest   WalletDebitRequest? @relation(fields: [walletDebitRequestId], references: [debitRequestId])
  walletDebitRequestId String?
  debitAcknowledgedAt  DateTime?

  // Direct cash tracking
  cashReceiptReference String?

  // Financial
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [entryId])
  journalEntryId String?

  // Consecutive miss tracking
  isConsecutiveMiss Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime?

  @@index([cycleId])
  @@index([memberId])
  @@index([contributionStatus])
  @@index([agentId])
  @@index([tierId])
}

// ===================================
// Domain: Cash Management
// See `docs/domain/90-domain-cash-management.md`
// ===================================

enum CashCustodyUserRole {
  Agent
  UnitAdmin
  AreaAdmin
  ForumAdmin
}

enum CashCustodyStatus {
  Active
  Inactive
  Suspended
}

enum CashHandoverStatus {
  Initiated
  Acknowledged
  Rejected
  Cancelled
}

enum CashHandoverType {
  Normal
  AdminTransition
}

// Cash Custody - Tracks cash balance held by each user
model CashCustody {
  custodyId         String             @id @default(uuid())
  userId            String
  userRole          CashCustodyUserRole
  glAccountCode     String
  unitId            String?
  areaId            String?
  forumId           String?
  status            CashCustodyStatus  @default(Active)
  currentBalance    Decimal            @default(0) @db.Decimal(15, 2)
  totalReceived     Decimal            @default(0) @db.Decimal(15, 2)
  totalTransferred  Decimal            @default(0) @db.Decimal(15, 2)
  lastTransactionAt DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deactivatedAt     DateTime?
  deactivatedBy     String?
  deactivatedReason String?

  // Relations
  user              User               @relation(fields: [userId], references: [userId])
  unit              Unit?              @relation(fields: [unitId], references: [unitId])
  area              Area?              @relation(fields: [areaId], references: [areaId])
  forum             Forum?             @relation(fields: [forumId], references: [forumId])
  deactivatedByUser User?              @relation("CashCustodyDeactivatedBy", fields: [deactivatedBy], references: [userId])

  handoversFrom     CashHandover[]     @relation("HandoverFromCustody")
  handoversTo       CashHandover[]     @relation("HandoverToCustody")

  @@index([userId])
  @@index([status])
  @@index([forumId])
  @@index([glAccountCode])
  @@map("cash_custodies")
}

// Cash Handover - Records transfers between personnel
model CashHandover {
  handoverId        String             @id @default(uuid())
  handoverNumber    String             @unique
  fromUserId        String
  fromUserRole      CashCustodyUserRole
  fromCustodyId     String
  fromGlAccountCode String
  toUserId          String
  toUserRole        String             // Can be CashCustodyUserRole or 'SuperAdmin'
  toCustodyId       String?            // Null for SuperAdmin (goes to bank)
  toGlAccountCode   String
  amount            Decimal            @db.Decimal(15, 2)
  unitId            String?
  areaId            String?
  forumId           String
  status            CashHandoverStatus @default(Initiated)
  handoverType      CashHandoverType   @default(Normal)
  sourceHandoverId  String?
  requiresApproval  Boolean            @default(false)
  approvalRequestId String?
  journalEntryId    String?
  initiatedAt       DateTime
  acknowledgedAt    DateTime?
  rejectedAt        DateTime?
  cancelledAt       DateTime?
  initiatorNotes    String?
  receiverNotes     String?
  rejectionReason   String?
  createdBy         String
  updatedAt         DateTime           @updatedAt

  // Relations
  fromUser          User               @relation("HandoverFromUser", fields: [fromUserId], references: [userId])
  toUser            User               @relation("HandoverToUser", fields: [toUserId], references: [userId])
  fromCustody       CashCustody        @relation("HandoverFromCustody", fields: [fromCustodyId], references: [custodyId])
  toCustody         CashCustody?       @relation("HandoverToCustody", fields: [toCustodyId], references: [custodyId])
  sourceHandover    CashHandover?      @relation("HandoverChain", fields: [sourceHandoverId], references: [handoverId])
  childHandovers    CashHandover[]     @relation("HandoverChain")
  forum             Forum              @relation(fields: [forumId], references: [forumId])
  approvalRequest   ApprovalRequest?   @relation(fields: [approvalRequestId], references: [requestId])
  journalEntry      JournalEntry?      @relation(fields: [journalEntryId], references: [entryId])
  createdByUser     User               @relation("HandoverCreatedBy", fields: [createdBy], references: [userId])

  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@index([forumId])
  @@index([initiatedAt])
  @@index([sourceHandoverId])
  @@map("cash_handovers")
}
